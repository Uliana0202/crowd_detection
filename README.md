# Тестовое задание Сrowd detection
## Описание проекта
### Fine-tuning
Для задачи детекции была выбрана модель YOLO11. Также данная модель была дообучена на датасете [Crowd Human Crowd Detection](https://www.kaggle.com/datasets/menhari/crowd-human-crowd-detection).  

Полученные при обучении веса сохранены в `weights/best.pt` и используются основным приложением. Ноутбук `training/train_on_kaggle.ipynb` адаптирован для Kaggle и служит документацией дообучения, для работы основного приложения он необязателен.  

### Чтение видео
Реализовано асинхронное чтение видео с использованием многопоточности (`src/video_io.py`).  
Такой подход повышает общий FPS обработки, так как распараллеливает операции декодирования видео и инференса модели.

### Алгоритм ByteTrack
При детекции людей на видео возникает следующая проблема. Если человека временно перекрывает другой объект, то рамка (бокс) этого человека "мерцает", то есть временно пропадает.  

Для решения этой проблемы использован алгоритм [ByteTrack](https://arxiv.org/abs/2110.06864) (`src/tracker.py`). Он не отбрасывает детекции с низкой уверенностью, а использует их для восстановления траекторий.

### Детекция 
`src/detector.py` содержит инференс модели.  

В нем также реализован опциональный режим SAHI (Slicing Aided Hyper Inference). Кадр разрезается на фрагменты (640x640) перед подачей в нейросеть, что улучшает детектирование маленьких объектов, но может привести к дублированию рамок для одного и того же объекта.

## Установка
Проект протестирован на Python 3.10.10
1. Клонируйте репозиторий:
```
git clone https://github.com/Uliana0202/crowd_detection.git
cd crowd_detection
```
2. Установите зависимости:
```
pip install -r requirements.txt
```
## Запуск
Перед запуском поместите исходный файл crowd.mp4 в папку media/

### Стандартный режим (Рекомендуемый)
```
python main.py
```
###  Режим SAHI
```
python main.py --sahi
```
###  Расширенные настройки
```
python main.py --source media/crowd.mp4 --weights weights/best.pt --output output.mp4 --sahi
```
Описание аргументов:
| Аргумент | Описание | Значение по умолчанию |
| :--- | :--- | :--- |
| `--source` | Путь к входному видео | `media/crowd.mp4` |
| `--weights` | Путь к весам модели (`.pt`) | `weights/best.pt` |
| `--output` | Путь для сохранения результата | `output.mp4` |
| `--sahi` | Флаг для включения режима нарезки кадров (SAHI) | Отключено (False) |
